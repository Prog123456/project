<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Attendance Sheet</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap');

        * {
            font-family: 'Barlow', sans-serif;
        }
        .table th, .table td {
            padding: .5rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
            font-size: 0.875rem;
            text-align: center;
        }
        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #dee2e6;
        }
        .today {
            background-color: #e3f5e7;
        }
        .sunday {
            background-color: #f8e1e3;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Monthly Attendance Sheet</h2>
        <form>
            <div class="form-group row">
                <label for="month" class="col-sm-2 col-form-label">Select Month</label>
                <div class="col-sm-4">
                    <input type="month" class="form-control" id="month" value="2024-05">
                </div>
                <div class="col-sm-4">
                    <button type="button" class="btn btn-primary" onclick="generateTable()">Generate</button>
                </div>
            </div>
        </form>
        <table class="table table-bordered" id="attendanceTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Clock In</th>
                    <th>Break In</th>
                    <th>Break Out</th>
                    <th>Break In</th>
                    <th>Break Out</th>
                    <th>Break In</th>
                    <th>Break Out</th>
                    <th>Clock Out</th>
                    <th>Total Hours</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be generated by JavaScript -->
            </tbody>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        async function generateTable() {
            const monthInput = document.getElementById('month').value;
            const tableBody = document.querySelector('#attendanceTable tbody');
            tableBody.innerHTML = ''; // Clear previous table rows

            if (monthInput) {
                const [year, month] = monthInput.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                const today = new Date();
                const todayFormatted = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;

                // Fetch attendance data from the server
                let attendanceData = {};
                try {
                    const response = await fetch(`/attendance/?year=${year}&month=${month}`);
                    attendanceData = await response.json();
                } catch (error) {
                    console.error('Error fetching attendance data:', error);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.toLocaleString('default', { weekday: 'short' });
                    const formattedDate = `${String(day).padStart(2, '0')}-${String(month).padStart(2, '0')}-${year}`;

                    let rowClass = '';
                    if (formattedDate === todayFormatted) {
                        rowClass = 'today';
                    } else if (dayOfWeek === 'Sun') {
                        rowClass = 'sunday';
                    }

                    const row = document.createElement('tr');
                    row.className = rowClass;

                    // Get the attendance data for the current date
                    const attendance = attendanceData[formattedDate] || {};

                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${dayOfWeek}</td>
                        <td>${attendance.timeIn || ''}</td>
                        <td>${attendance.lunchIn || ''}</td>
                        <td>${attendance.lunchOut || ''}</td>
                        <td>${attendance.lunchIn || ''}</td>
                        <td>${attendance.lunchOut || ''}</td>
                        <td>${attendance.lunchIn || ''}</td>
                        <td>${attendance.lunchOut || ''}</td>
                        <td>${attendance.timeOut || ''}</td>
                        <td>${calculateTotalHours(attendance.timeIn, attendance.lunchOut, attendance.lunchIn, attendance.timeOut)}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
        }

        function calculateTotalHours(timeIn, lunchOut, lunchIn, timeOut) {
            if (timeIn && timeOut) {
                const startTime = new Date(`1970-01-01T${timeIn}Z`);
                const endTime = new Date(`1970-01-01T${timeOut}Z`);
                let totalHours = (endTime - startTime) / (1000 * 60 * 60); // Difference in hours

                if (lunchOut && lunchIn) {
                    const lunchStart = new Date(`1970-01-01T${lunchOut}Z`);
                    const lunchEnd = new Date(`1970-01-01T${lunchIn}Z`);
                    totalHours -= (lunchEnd - lunchStart) / (1000 * 60 * 60); // Subtract lunch break duration
                }

                return totalHours.toFixed(2); // Return total hours with two decimal places
            }
            return '';
        }

        document.addEventListener('DOMContentLoaded', generateTable);
    </script>
</body>
</html>
